% filepath: diagnose_bayesian_convergence_documentation.tex
\documentclass[a4paper,12pt,dvipdfmx]{jlreq}
\usepackage{amsmath,amssymb,amsthm}
\usepackage{bm}
\usepackage{physics}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows, positioning, fit, backgrounds, calc}
\usepackage{algorithm2e}
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{tcolorbox}
\usepackage{listings}
\usepackage{siunitx}
\usepackage{multicol}

% ã‚«ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹è¨­å®š
\newtcolorbox{keypoint}{colback=blue!5!white,colframe=blue!75!black,title=Key Point}
\newtcolorbox{warning}{colback=red!5!white,colframe=red!75!black,title=æ³¨æ„}
\newtcolorbox{definition}{colback=green!5!white,colframe=green!50!black,title=å®šç¾©}
\newtcolorbox{diagnostic}{colback=orange!5!white,colframe=orange!75!black,title=è¨ºæ–­æŒ‡æ¨™}

\lstset{
    basicstyle=\footnotesize\ttfamily,
    keywordstyle=\color{blue},
    commentstyle=\color{gray},
    breaklines=true,
    frame=single
}

\title{\vspace{-2cm}
\textbf{diagnose\_bayesian\_convergence.py ç†è§£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ}\\
\large MCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®åæŸè¨ºæ–­ãƒ„ãƒ¼ãƒ«
}
\author{ç‰©ç†å·¥å­¦å°‚æ”» ä¿®å£«è«–æ–‡è§£æç”¨æ•™æ}
\date{2026å¹´1æœˆç‰ˆ}

\begin{document}
\maketitle

\tableofcontents
\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ã¯ã˜ã‚ã«ï¼šã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ç›®çš„}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{keypoint}
ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ãƒ™ã‚¤ã‚ºæ¨å®šï¼ˆMCMCï¼‰ã®çµæœãŒ\textbf{çµ±è¨ˆçš„ã«ä¿¡é ¼ã§ãã‚‹ã‹}ã‚’
è¨ºæ–­ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚MCMCãŒæ­£ã—ãåæŸã—ã¦ã„ãªã‘ã‚Œã°ã€
æ¨å®šã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„ä¸ç¢ºã‹ã•ã¯æ„å‘³ã‚’æŒã¡ã¾ã›ã‚“ã€‚
\end{keypoint}

\subsection{ãªãœåæŸè¨ºæ–­ãŒå¿…è¦ã‹ï¼Ÿ}

MCMCã¯ã€Œååˆ†ã«é•·ãå®Ÿè¡Œã™ã‚Œã°ã€äº‹å¾Œåˆ†å¸ƒã«åæŸã—ã¾ã™ãŒã€
å®Ÿéš›ã«ã¯ä»¥ä¸‹ã®å•é¡ŒãŒèµ·ã“ã‚Šãˆã¾ã™ï¼š

\begin{enumerate}
    \item \textbf{æœªåæŸ}ï¼šã‚µãƒ³ãƒ—ãƒ«æ•°ãŒä¸è¶³ã—ã€çœŸã®äº‹å¾Œåˆ†å¸ƒã‚’æ¢ç´¢ã§ãã¦ã„ãªã„
    \item \textbf{å±€æ‰€è§£ã¸ã®å›ºç€}ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç©ºé–“ã®ä¸€éƒ¨ã«ã®ã¿æ»åœ¨
    \item \textbf{é«˜ã„è‡ªå·±ç›¸é–¢}ï¼šé€£ç¶šã‚µãƒ³ãƒ—ãƒ«ãŒç‹¬ç«‹ã§ãªãã€å®Ÿè³ªçš„ãªã‚µãƒ³ãƒ—ãƒ«æ•°ãŒå°‘ãªã„
    \item \textbf{ãƒã‚§ãƒ¼ãƒ³é–“ã®ä¸ä¸€è‡´}ï¼šç•°ãªã‚‹ãƒã‚§ãƒ¼ãƒ³ãŒç•°ãªã‚‹é ˜åŸŸã‚’æ¢ç´¢
\end{enumerate}

\subsection{ä½¿ç”¨æ–¹æ³•}

\begin{lstlisting}[language=bash]
python diagnose_bayesian_convergence.py <çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>

# ä¾‹:
python diagnose_bayesian_convergence.py bayesian_results_v6_informed_HB_20260108_013540
\end{lstlisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{åæŸè¨ºæ–­ã®æŒ‡æ¨™}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{$\hat{R}$çµ±è¨ˆé‡ï¼ˆGelman-Rubinè¨ºæ–­ï¼‰}

\begin{definition}
\textbf{$\hat{R}$ï¼ˆR-hatï¼‰}ã¯ã€è¤‡æ•°ã®ç‹¬ç«‹ã—ãŸãƒãƒ«ã‚³ãƒ•é€£é–ï¼ˆãƒã‚§ãƒ¼ãƒ³ï¼‰ã‚’æ¯”è¼ƒã™ã‚‹ã“ã¨ã§
åæŸã‚’åˆ¤å®šã™ã‚‹æŒ‡æ¨™ã§ã™ã€‚
\end{definition}

\subsubsection{è¨ˆç®—æ–¹æ³•}

$M$å€‹ã®ãƒã‚§ãƒ¼ãƒ³ãŒã‚ã‚Šã€å„ãƒã‚§ãƒ¼ãƒ³ã«$N$å€‹ã®ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

\begin{enumerate}
    \item \textbf{ãƒã‚§ãƒ¼ãƒ³å†…åˆ†æ•£} $W$ï¼ˆWithin-chain varianceï¼‰:
    \begin{equation}
    W = \frac{1}{M} \sum_{m=1}^{M} s_m^2, \quad s_m^2 = \frac{1}{N-1} \sum_{n=1}^{N} (\theta_{mn} - \bar{\theta}_m)^2
    \end{equation}
    
    \item \textbf{ãƒã‚§ãƒ¼ãƒ³é–“åˆ†æ•£} $B$ï¼ˆBetween-chain varianceï¼‰:
    \begin{equation}
    B = \frac{N}{M-1} \sum_{m=1}^{M} (\bar{\theta}_m - \bar{\theta})^2
    \end{equation}
    
    \item \textbf{æ¨å®šåˆ†æ•£}:
    \begin{equation}
    \hat{\text{Var}}(\theta) = \frac{N-1}{N} W + \frac{1}{N} B
    \end{equation}
    
    \item \textbf{$\hat{R}$çµ±è¨ˆé‡}:
    \begin{equation}
    \boxed{\hat{R} = \sqrt{\frac{\hat{\text{Var}}(\theta)}{W}}}
    \end{equation}
\end{enumerate}

\subsubsection{è§£é‡ˆ}

\begin{table}[h]
\centering
\caption{$\hat{R}$ã®è§£é‡ˆåŸºæº–}
\begin{tabular}{cll}
\toprule
\textbf{$\hat{R}$ã®å€¤} & \textbf{åˆ¤å®š} & \textbf{ã‚¢ã‚¯ã‚·ãƒ§ãƒ³} \\
\midrule
$< 1.01$ & âœ… å„ªç§€ & ãã®ã¾ã¾ä½¿ç”¨å¯èƒ½ \\
$1.01 - 1.05$ & âš ï¸ è¨±å®¹ç¯„å›² & æ³¨æ„ã—ãªãŒã‚‰ä½¿ç”¨ \\
$1.05 - 1.10$ & âš ï¸ è¦æ³¨æ„ & ã‚µãƒ³ãƒ—ãƒ«æ•°å¢—åŠ ã‚’æ¤œè¨ \\
$> 1.10$ & âŒ æœªåæŸ & å¿…ãšã‚µãƒ³ãƒ—ãƒ«æ•°å¢—åŠ  \\
\bottomrule
\end{tabular}
\end{table}

\begin{figure}[h]
\centering
\begin{tikzpicture}[scale=0.8]
% è‰¯å¥½ãªåæŸ
\begin{scope}
    \draw[->] (0,0) -- (6,0) node[right] {\small Iteration};
    \draw[->] (0,0) -- (0,3.5) node[above] {\small $\theta$};
    
    \foreach \c/\col in {1/red, 2/blue, 3/green!60!black, 4/orange} {
        \draw[\col, opacity=0.7] 
            plot[domain=0:5.5, samples=40, smooth] 
            (\x, {1.8 + 0.3*rand});
    }
    
    \node[below] at (3,-0.5) {\textbf{$\hat{R} \approx 1.0$}};
    \node[below] at (3,-1) {\small å…¨ãƒã‚§ãƒ¼ãƒ³ãŒåŒã˜é ˜åŸŸ};
\end{scope}

% æœªåæŸ
\begin{scope}[xshift=9cm]
    \draw[->] (0,0) -- (6,0) node[right] {\small Iteration};
    \draw[->] (0,0) -- (0,3.5) node[above] {\small $\theta$};
    
    \draw[red, opacity=0.7] plot[domain=0:5.5, samples=30] 
        (\x, {0.8 + 0.15*\x + 0.15*rand});
    \draw[blue, opacity=0.7] plot[domain=0:5.5, samples=30] 
        (\x, {2.8 - 0.1*\x + 0.15*rand});
    \draw[green!60!black, opacity=0.7] plot[domain=0:5.5, samples=30] 
        (\x, {1.5 + 0.2*rand});
    \draw[orange, opacity=0.7] plot[domain=0:5.5, samples=30] 
        (\x, {2.0 + 0.08*\x + 0.2*rand});
    
    \node[below] at (3,-0.5) {\textbf{$\hat{R} > 1.1$}};
    \node[below] at (3,-1) {\small ãƒã‚§ãƒ¼ãƒ³ãŒåˆ†é›¢};
\end{scope}
\end{tikzpicture}
\caption{$\hat{R}$ã«ã‚ˆã‚‹åæŸåˆ¤å®šã®å¯è¦–åŒ–}
\label{fig:rhat}
\end{figure}

\subsection{æœ‰åŠ¹ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºï¼ˆESSï¼‰}

\begin{definition}
\textbf{ESSï¼ˆEffective Sample Sizeï¼‰}ã¯ã€è‡ªå·±ç›¸é–¢ã‚’è€ƒæ…®ã—ãŸ
ã€Œå®Ÿè³ªçš„ã«ç‹¬ç«‹ãªã€ã‚µãƒ³ãƒ—ãƒ«æ•°ã§ã™ã€‚
\end{definition}

MCMCã‚µãƒ³ãƒ—ãƒ«ã¯æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚Šã€é€£ç¶šã—ãŸã‚µãƒ³ãƒ—ãƒ«ã¯ç›¸é–¢ã‚’æŒã¡ã¾ã™ã€‚
$N$å€‹ã®ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã£ã¦ã‚‚ã€ç‹¬ç«‹ãªã‚µãƒ³ãƒ—ãƒ«æ•°ã¯$N$ã‚ˆã‚Šå°‘ãªããªã‚Šã¾ã™ã€‚

\subsubsection{è¨ˆç®—æ–¹æ³•}

è‡ªå·±ç›¸é–¢é–¢æ•°$\rho_k$ï¼ˆãƒ©ã‚°$k$ã®ç›¸é–¢ï¼‰ã‚’ç”¨ã„ã¦ï¼š

\begin{equation}
\boxed{\text{ESS} = \frac{N}{1 + 2\sum_{k=1}^{K} \rho_k}}
\end{equation}

ã“ã“ã§$K$ã¯è‡ªå·±ç›¸é–¢ãŒç„¡è¦–ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ãƒ©ã‚°ã€‚

\subsubsection{ESSã®ç¨®é¡}

\begin{itemize}
    \item \textbf{ESS\_bulk}ï¼šåˆ†å¸ƒã®ä¸­å¿ƒï¼ˆå¹³å‡ã€ä¸­å¤®å€¤ï¼‰ã®æ¨å®šç²¾åº¦
    \item \textbf{ESS\_tail}ï¼šåˆ†å¸ƒã®è£¾ï¼ˆä¿¡é ¼åŒºé–“ã®ç«¯ï¼‰ã®æ¨å®šç²¾åº¦
\end{itemize}

\begin{table}[h]
\centering
\caption{ESSã®è§£é‡ˆåŸºæº–}
\begin{tabular}{cll}
\toprule
\textbf{ESS} & \textbf{åˆ¤å®š} & \textbf{æ„å‘³} \\
\midrule
$\geq 400$ & âœ… ååˆ† & ä¿¡é ¼ã§ãã‚‹æ¨å®š \\
$100 - 400$ & âš ï¸ ä¸è¶³æ°—å‘³ & ç²¾åº¦å‘ä¸Šã®ä½™åœ°ã‚ã‚Š \\
$< 100$ & âŒ å±é™º & æ¨å®šãŒä¸å®‰å®š \\
\bottomrule
\end{tabular}
\end{table}

\begin{keypoint}
ESS $\geq 400$ ã®ç›®å®‰ã¯ã€äº‹å¾Œå¹³å‡ã®æ¨™æº–èª¤å·®ï¼ˆMCSEï¼‰ã‚’äº‹å¾Œæ¨™æº–åå·®ã®5\%ä»¥ä¸‹ã«
æŠ‘ãˆã‚‹ãŸã‚ã«å¿…è¦ãªã‚µãƒ³ãƒ—ãƒ«æ•°ã«åŸºã¥ã„ã¦ã„ã¾ã™ï¼š
\[
\text{MCSE} = \frac{\text{SD}}{\sqrt{\text{ESS}}} \leq 0.05 \times \text{SD} \quad \Rightarrow \quad \text{ESS} \geq 400
\]
\end{keypoint}

\subsection{è‡ªå·±ç›¸é–¢}

\begin{definition}
\textbf{è‡ªå·±ç›¸é–¢}$\rho_k$ã¯ã€$k$ã‚¹ãƒ†ãƒƒãƒ—é›¢ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«é–“ã®ç›¸é–¢ä¿‚æ•°ï¼š
\begin{equation}
\rho_k = \frac{\text{Cov}(\theta_t, \theta_{t+k})}{\text{Var}(\theta_t)}
\end{equation}
\end{definition}

ç†æƒ³çš„ã«ã¯ã€è‡ªå·±ç›¸é–¢ã¯å°ã•ã„ãƒ©ã‚°$k$ã§æ€¥é€Ÿã«0ã«æ¸›è¡°ã™ã¹ãã§ã™ã€‚

\begin{figure}[h]
\centering
\begin{tikzpicture}[scale=0.8]
% è‰¯å¥½ãªè‡ªå·±ç›¸é–¢
\begin{scope}
    \draw[->] (0,0) -- (5,0) node[right] {\small Lag $k$};
    \draw[->] (0,0) -- (0,3) node[above] {\small $\rho_k$};
    
    \draw[thick, blue] plot[domain=0:4.5, samples=20] 
        (\x, {2.5*exp(-\x)});
    
    \draw[dashed, gray] (0,0.2) -- (5,0.2);
    
    \node[below] at (2.5,-0.5) {\textbf{è‰¯å¥½}};
    \node[below] at (2.5,-1) {\small æ€¥é€Ÿã«æ¸›è¡° â†’ é«˜ESS};
\end{scope}

% å•é¡Œã®ã‚ã‚‹è‡ªå·±ç›¸é–¢
\begin{scope}[xshift=8cm]
    \draw[->] (0,0) -- (5,0) node[right] {\small Lag $k$};
    \draw[->] (0,0) -- (0,3) node[above] {\small $\rho_k$};
    
    \draw[thick, red] plot[domain=0:4.5, samples=20] 
        (\x, {2.5*exp(-0.2*\x)});
    
    \draw[dashed, gray] (0,0.2) -- (5,0.2);
    
    \node[below] at (2.5,-0.5) {\textbf{å•é¡Œã‚ã‚Š}};
    \node[below] at (2.5,-1) {\small ç·©ã‚„ã‹ãªæ¸›è¡° â†’ ä½ESS};
\end{scope}
\end{tikzpicture}
\caption{è‡ªå·±ç›¸é–¢ãƒ—ãƒ­ãƒƒãƒˆã®è§£é‡ˆ}
\label{fig:autocorr}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æ©Ÿèƒ½}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{ç”Ÿæˆã•ã‚Œã‚‹è¨ºæ–­ãƒ—ãƒ­ãƒƒãƒˆ}

\begin{table}[h]
\centering
\caption{å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§}
\begin{tabular}{ll}
\toprule
\textbf{ãƒ•ã‚¡ã‚¤ãƒ«å} & \textbf{å†…å®¹} \\
\midrule
\texttt{detailed\_trace\_H.png} & Hå½¢å¼ï¼šäº‹å¾Œåˆ†å¸ƒãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  + ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{detailed\_trace\_B.png} & Bå½¢å¼ï¼šäº‹å¾Œåˆ†å¸ƒãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  + ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{ess\_comparison.png} & H/Bå½¢å¼ã®ESSæ¯”è¼ƒãƒãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{rhat\_comparison.png} & H/Bå½¢å¼ã®$\hat{R}$æ¯”è¼ƒãƒãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{correlation\_H.png} & Hå½¢å¼ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ç›¸é–¢ãƒšã‚¢ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{correlation\_B.png} & Bå½¢å¼ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ç›¸é–¢ãƒšã‚¢ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{rank\_plot\_H.png} & Hå½¢å¼ï¼šãƒ©ãƒ³ã‚¯ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{rank\_plot\_B.png} & Bå½¢å¼ï¼šãƒ©ãƒ³ã‚¯ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{autocorr\_H.png} & Hå½¢å¼ï¼šè‡ªå·±ç›¸é–¢ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{autocorr\_B.png} & Bå½¢å¼ï¼šè‡ªå·±ç›¸é–¢ãƒ—ãƒ­ãƒƒãƒˆ \\
\texttt{convergence\_report.md} & åæŸè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆï¼ˆMarkdownï¼‰ \\
\bottomrule
\end{tabular}
\end{table}

\subsection{è©³ç´°ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆ}

å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¤ã„ã¦2ã¤ã®ãƒ‘ãƒãƒ«ã‚’ç”Ÿæˆï¼š

\begin{enumerate}
    \item \textbf{å·¦ãƒ‘ãƒãƒ«}ï¼šäº‹å¾Œåˆ†å¸ƒãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
    \begin{itemize}
        \item é’ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ï¼šã‚µãƒ³ãƒ—ãƒ«åˆ†å¸ƒ
        \item èµ¤ç ´ç·šï¼šäº‹å¾Œå¹³å‡
        \item ã‚ªãƒ¬ãƒ³ã‚¸ç‚¹ç·šï¼š2.5\%, 97.5\%ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ï¼ˆ95\%ä¿¡é ¼åŒºé–“ï¼‰
    \end{itemize}
    
    \item \textbf{å³ãƒ‘ãƒãƒ«}ï¼šãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆ
    \begin{itemize}
        \item 8æœ¬ã®ãƒã‚§ãƒ¼ãƒ³ã‚’è‰²åˆ†ã‘è¡¨ç¤º
        \item ESS ã¨ $\hat{R}$ ã‚’ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
        \item âœ…/âš ï¸ ãƒãƒ¼ã‚¯ã§åæŸçŠ¶æ…‹ã‚’ç¤ºã™
    \end{itemize}
\end{enumerate}

\subsection{ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ç›¸é–¢ãƒ—ãƒ­ãƒƒãƒˆ}

\begin{definition}
\textbf{ãƒšã‚¢ãƒ—ãƒ­ãƒƒãƒˆ}ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å…¨ãƒšã‚¢ã«ã¤ã„ã¦2æ¬¡å…ƒäº‹å¾Œåˆ†å¸ƒã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚
å¼·ã„ç›¸é–¢ãŒã‚ã‚‹ã¨ã€MCMCã®æ¢ç´¢åŠ¹ç‡ãŒä½ä¸‹ã—ã¾ã™ã€‚
\end{definition}

\begin{figure}[h]
\centering
\begin{tikzpicture}[scale=0.7]
% ä½ç›¸é–¢
\begin{scope}
    \draw[->] (0,0) -- (4,0) node[right] {$\theta_1$};
    \draw[->] (0,0) -- (0,4) node[above] {$\theta_2$};
    
    \filldraw[blue!30, draw=blue] (2,2) circle (1cm and 0.9cm);
    
    \node[below] at (2,-0.5) {\textbf{ä½ç›¸é–¢}};
    \node[below] at (2,-1) {\small å††å½¢ â†’ æ¢ç´¢å®¹æ˜“};
\end{scope}

% é«˜ç›¸é–¢
\begin{scope}[xshift=7cm]
    \draw[->] (0,0) -- (4,0) node[right] {$\theta_1$};
    \draw[->] (0,0) -- (0,4) node[above] {$\theta_2$};
    
    \filldraw[red!30, draw=red, rotate around={45:(2,2)}] (2,2) ellipse (1.5cm and 0.3cm);
    
    \node[below] at (2,-0.5) {\textbf{é«˜ç›¸é–¢}};
    \node[below] at (2,-1) {\small ç´°é•·ã„æ¥•å†† â†’ æ¢ç´¢å›°é›£};
\end{scope}
\end{tikzpicture}
\caption{ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ç›¸é–¢ã¨äº‹å¾Œåˆ†å¸ƒã®å½¢çŠ¶}
\label{fig:correlation}
\end{figure}

\subsection{ãƒ©ãƒ³ã‚¯ãƒ—ãƒ­ãƒƒãƒˆ}

\begin{definition}
\textbf{ãƒ©ãƒ³ã‚¯ãƒ—ãƒ­ãƒƒãƒˆ}ã¯ã€å„ãƒã‚§ãƒ¼ãƒ³ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ—ãƒ¼ãƒ«ã—ã€
å…¨ä½“ã§ã®ãƒ©ãƒ³ã‚¯ï¼ˆé †ä½ï¼‰ã‚’è¨ˆç®—ã—ã¦ã€ãƒã‚§ãƒ¼ãƒ³ã”ã¨ã«ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ åŒ–ã—ã¾ã™ã€‚
\end{definition}

åæŸã—ã¦ã„ã‚‹å ´åˆã€å…¨ãƒã‚§ãƒ¼ãƒ³ã®ãƒ©ãƒ³ã‚¯ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¯ä¸€æ§˜åˆ†å¸ƒã«è¿‘ããªã‚Šã¾ã™ã€‚
ç‰¹å®šã®ãƒã‚§ãƒ¼ãƒ³ã ã‘ãŒé«˜ã„/ä½ã„ãƒ©ãƒ³ã‚¯ã«åã£ã¦ã„ã‚Œã°ã€æœªåæŸã®å…†å€™ã§ã™ã€‚

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ•ãƒ­ãƒ¼}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{figure}[h]
\centering
\begin{tikzpicture}[
    node distance=0.8cm,
    startstop/.style={rectangle, rounded corners, minimum width=3cm, minimum height=0.7cm, 
                      text centered, draw=black, fill=red!30},
    process/.style={rectangle, minimum width=3.5cm, minimum height=0.7cm, 
                    text centered, draw=black, fill=orange!30},
    io/.style={trapezium, trapezium left angle=70, trapezium right angle=110, 
               minimum width=2.5cm, minimum height=0.7cm, text centered, draw=black, fill=blue!30},
    decision/.style={diamond, minimum width=2cm, minimum height=1cm, 
                     text centered, draw=black, fill=green!30},
    arrow/.style={thick,->,>=stealth}
]

\node (start) [startstop] {é–‹å§‹};
\node (load) [io, below=of start] {ãƒˆãƒ¬ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ (H/B)};
\node (summary) [process, below=of load] {çµ±è¨ˆã‚µãƒãƒªãƒ¼è¨ˆç®—};
\node (check) [decision, below=of summary, aspect=2] {$\hat{R} > 1.01$?};
\node (warn) [process, right=2cm of check, fill=red!20] {è­¦å‘Šå‡ºåŠ›};
\node (ess) [decision, below=of check, aspect=2] {ESS $< 400$?};
\node (warn2) [process, right=2cm of ess, fill=red!20] {è­¦å‘Šå‡ºåŠ›};
\node (plot1) [process, below=of ess] {è©³ç´°ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆ};
\node (plot2) [process, below=of plot1] {ç›¸é–¢ãƒ—ãƒ­ãƒƒãƒˆ};
\node (plot3) [process, below=of plot2] {ESS/$\hat{R}$æ¯”è¼ƒãƒ—ãƒ­ãƒƒãƒˆ};
\node (report) [io, below=of plot3] {ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ};
\node (end) [startstop, below=of report] {çµ‚äº†};

\draw [arrow] (start) -- (load);
\draw [arrow] (load) -- (summary);
\draw [arrow] (summary) -- (check);
\draw [arrow] (check) -- node[above] {Yes} (warn);
\draw [arrow] (check) -- node[right] {No} (ess);
\draw [arrow] (warn) |- (ess);
\draw [arrow] (ess) -- node[above] {Yes} (warn2);
\draw [arrow] (ess) -- node[right] {No} (plot1);
\draw [arrow] (warn2) |- (plot1);
\draw [arrow] (plot1) -- (plot2);
\draw [arrow] (plot2) -- (plot3);
\draw [arrow] (plot3) -- (report);
\draw [arrow] (report) -- (end);

\end{tikzpicture}
\caption{ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ}
\label{fig:flow}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{åæŸè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã®èª­ã¿æ–¹}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{ãƒ¬ãƒãƒ¼ãƒˆã®æ§‹æˆ}

\texttt{convergence\_report.md}ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š

\begin{enumerate}
    \item \textbf{Hå½¢å¼/Bå½¢å¼ã”ã¨ã®è¨ºæ–­çµæœ}
    \begin{itemize}
        \item $\hat{R} > 1.01$ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§
        \item ESS $< 400$ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§
        \item å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®çµ±è¨ˆã‚µãƒãƒªãƒ¼
    \end{itemize}
    
    \item \textbf{æ¨å¥¨äº‹é …}
    \begin{itemize}
        \item å•é¡ŒãŒã‚ã‚‹å ´åˆã®å¯¾å‡¦æ³•
        \item ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨­å®šã®èª¿æ•´æ¡ˆ
    \end{itemize}
\end{enumerate}

\subsection{å•é¡ŒãŒã‚ã‚‹å ´åˆã®å¯¾å‡¦æ³•}

\begin{table}[h]
\centering
\caption{åæŸå•é¡Œã¨å¯¾å‡¦æ³•}
\begin{tabular}{lp{8cm}}
\toprule
\textbf{å•é¡Œ} & \textbf{å¯¾å‡¦æ³•} \\
\midrule
$\hat{R} > 1.1$ & 
\begin{itemize}
    \item ã‚µãƒ³ãƒ—ãƒ«æ•°ï¼ˆdrawsï¼‰ã‚’2ã€œ3å€ã«å¢—åŠ 
    \item ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ï¼ˆtuneï¼‰ã‚’å¢—åŠ 
    \item ãƒã‚§ãƒ¼ãƒ³æ•°ã‚’å¢—ã‚„ã—ã¦ç¢ºèª
\end{itemize} \\
\midrule
ESS $< 100$ & 
\begin{itemize}
    \item ã‚µãƒ³ãƒ—ãƒ«æ•°ã‚’å¤§å¹…ã«å¢—åŠ 
    \item äº‹å‰åˆ†å¸ƒã®$\sigma$ã‚’æ‹¡å¤§
    \item å†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚’æ¤œè¨
\end{itemize} \\
\midrule
é«˜ã„ç›¸é–¢ & 
\begin{itemize}
    \item ç›¸é–¢ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ã§å†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–
    \item äº‹å‰åˆ†å¸ƒã‚’ç·©å’Œ
    \item ã‚ˆã‚ŠåŠ¹ç‡çš„ãªã‚µãƒ³ãƒ—ãƒ©ãƒ¼ã‚’æ¤œè¨
\end{itemize} \\
\bottomrule
\end{tabular}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ä¸»è¦é–¢æ•°ã®èª¬æ˜}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{diagnose\_convergence}

\begin{lstlisting}[language=Python]
def diagnose_convergence(trace, model_name, output_dir):
    """
    åæŸè¨ºæ–­ã®è©³ç´°åˆ†æ
    
    Parameters
    ----------
    trace : az.InferenceData
        ArviZãƒˆãƒ¬ãƒ¼ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    model_name : str
        'H' ã¾ãŸã¯ 'B'
    output_dir : pathlib.Path
        å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    
    Returns
    -------
    summary : pd.DataFrame
        ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿çµ±è¨ˆã‚µãƒãƒªãƒ¼
    
    å‡ºåŠ›
    ----
    - R-hat > 1.01 ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è­¦å‘Š
    - ESS < 400 ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è­¦å‘Š
    - ESS < 100 ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å±é™ºã¨ã—ã¦å ±å‘Š
    """
\end{lstlisting}

\subsection{plot\_detailed\_trace}

\begin{lstlisting}[language=Python]
def plot_detailed_trace(trace, model_name, output_dir):
    """
    è©³ç´°ãªãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆç”Ÿæˆ
    
    å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¤ã„ã¦:
    - å·¦: äº‹å¾Œåˆ†å¸ƒãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ï¼ˆå¹³å‡ã€95%CIä»˜ãï¼‰
    - å³: 8ãƒã‚§ãƒ¼ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆï¼ˆESS/R-hatè¡¨ç¤ºï¼‰
    
    å‡ºåŠ›: detailed_trace_{model_name}.png
    """
\end{lstlisting}

\subsection{generate\_convergence\_report}

\begin{lstlisting}[language=Python]
def generate_convergence_report(traces, output_dir):
    """
    åæŸè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆMarkdownå½¢å¼ï¼‰
    
    å†…å®¹:
    - H/Bå½¢å¼ã”ã¨ã®å•é¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    - å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚µãƒãƒªãƒ¼çµ±è¨ˆ
    - å•é¡ŒãŒã‚ã‚‹å ´åˆã®æ¨å¥¨äº‹é …
    
    å‡ºåŠ›: convergence_report.md
    """
\end{lstlisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{å®Ÿè·µçš„ãªä½¿ç”¨ä¾‹}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{å…¸å‹çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼}

\begin{enumerate}
    \item ãƒ™ã‚¤ã‚ºæ¨å®šã‚’å®Ÿè¡Œ
    \begin{lstlisting}[language=bash]
python bayesian_v6_informed_priors_HB.py
    \end{lstlisting}
    
    \item åæŸè¨ºæ–­ã‚’å®Ÿè¡Œ
    \begin{lstlisting}[language=bash]
python diagnose_bayesian_convergence.py bayesian_results_v6_...
    \end{lstlisting}
    
    \item ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª
    \begin{lstlisting}[language=bash]
cat bayesian_results_v6_.../diagnostics/convergence_report.md
    \end{lstlisting}
    
    \item å•é¡ŒãŒã‚ã‚Œã°è¨­å®šã‚’èª¿æ•´ã—ã¦å†å®Ÿè¡Œ
\end{enumerate}

\subsection{å‡ºåŠ›ä¾‹ã®è§£é‡ˆ}

\begin{lstlisting}
======================================================================
ğŸ“Š Hå½¢å¼ åæŸè¨ºæ–­
======================================================================

ã€R-hatè¨ºæ–­ã€‘
âœ… å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§R-hat < 1.01

ã€ESSè¨ºæ–­ã€‘
âš ï¸ ESS_bulk < 400 ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
   - B4: ESS_bulk = 287, ESS_tail = 312
   - B6: ESS_bulk = 203, ESS_tail = 245
\end{lstlisting}

è§£é‡ˆï¼š
\begin{itemize}
    \item $\hat{R}$ã¯å•é¡Œãªã—ï¼ˆå…¨ãƒã‚§ãƒ¼ãƒ³åæŸæ¸ˆã¿ï¼‰
    \item $B_4$, $B_6$ã®ESSãŒä½ã„ $\to$ ã‚µãƒ³ãƒ—ãƒ«æ•°å¢—åŠ æ¨å¥¨
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ã¾ã¨ã‚}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{enumerate}
    \item \textbf{ç›®çš„}ï¼šMCMCã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã®ä¿¡é ¼æ€§ã‚’å®šé‡çš„ã«è©•ä¾¡
    
    \item \textbf{ä¸»è¦æŒ‡æ¨™}ï¼š
    \begin{itemize}
        \item $\hat{R}$ï¼šãƒã‚§ãƒ¼ãƒ³é–“ã®ä¸€è‡´åº¦ï¼ˆ$< 1.01$ãŒç†æƒ³ï¼‰
        \item ESSï¼šå®Ÿè³ªçš„ãªç‹¬ç«‹ã‚µãƒ³ãƒ—ãƒ«æ•°ï¼ˆ$\geq 400$ãŒæ¨å¥¨ï¼‰
        \item è‡ªå·±ç›¸é–¢ï¼šé€£ç¶šã‚µãƒ³ãƒ—ãƒ«é–“ã®ä¾å­˜æ€§
    \end{itemize}
    
    \item \textbf{å‡ºåŠ›}ï¼š
    \begin{itemize}
        \item è©³ç´°ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒƒãƒˆ
        \item ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é–“ç›¸é–¢ãƒ—ãƒ­ãƒƒãƒˆ
        \item ESS/$\hat{R}$æ¯”è¼ƒãƒãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ
        \item Markdownãƒ¬ãƒãƒ¼ãƒˆ
    \end{itemize}
    
    \item \textbf{æ´»ç”¨}ï¼š
    \begin{itemize}
        \item å•é¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç‰¹å®š
        \item ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¨­å®šã®æ”¹å–„æ–¹é‡æ±ºå®š
        \item æ¨å®šçµæœã®ä¿¡é ¼æ€§è©•ä¾¡
    \end{itemize}
\end{enumerate}

\begin{keypoint}
MCMCã®çµæœã‚’å ±å‘Šã™ã‚‹éš›ã¯ã€å¿…ãšåæŸè¨ºæ–­ã®çµæœï¼ˆ$\hat{R}$ã€ESSï¼‰ã‚’æ·»ãˆã¾ã—ã‚‡ã†ã€‚
åæŸã—ã¦ã„ãªã„MCMCã®çµæœã¯ã€çµ±è¨ˆçš„ã«ç„¡æ„å‘³ã§ã™ã€‚
\end{keypoint}

\end{document}
